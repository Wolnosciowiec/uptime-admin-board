name: "RiotKit HealthFlux pipeline - test & release"
on:
    push:
    pull_request:
        branches:
            - master
            - primary

jobs:
    test_each_new_commit:
        runs-on: ubuntu-20.04
        steps:
            - name: "Checkout"
              uses: actions/checkout@v1

            # —— Dependencies —————————————————————————————————————————————————————————
            - name: "Install build dependencies"
              run: "sudo pip install -r ./requirements.txt"

            - name: Setup PHP, extensions and composer
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.0"
                  extensions: openssl, json, swoole
                  tools: symfony, composer
              env:
                  update: true

            - name: "Install application dependencies"
              run: "rkd :setup"

            # —— Tests —————————————————————————————————————————————————————————
            - name: "Run tests"
              run: "PHP_BIN=php rkd :run:tests"

            - name: PHPUnit tests
              uses: php-actions/phpunit@v1
              with:
                  memory_limit: 256M

            # —— Reports ———————————————————————————————————————————————————————
            - name: "Make HTML report from unit tests"
              run: "rkd :test:unit:html"
              if: ${{ always() }}

            - name: "Archive results"
              uses: actions/upload-artifact@v2
              if: ${{ always() }}
              with:
                  name: tests-results
                  path: var/tests

    release_docker:
        needs: [ test_each_new_commit ]
        runs-on: ubuntu-20.04
        steps:
            - name: Checkout
              uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: "Login to quay"
              uses: docker/login-action@v1
              with:
                  registry: quay.io
                  username: ${{ secrets.QUAY_USERNAME }}
                  password: ${{ secrets.QUAY_PASSWORD }}

            - name: "Install build dependencies"
              run: "sudo pip install -r ./requirements.txt"

            - name: "Build and publish docker"
              run: "rkd :release:docker"
